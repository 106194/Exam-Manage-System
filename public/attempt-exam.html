<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Attempt Exam</title>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      margin: 0;
      background: #f9f9f9;
      padding: 20px;
    }

    .container {
      max-width: 900px;
      margin: auto;
      background: #fff;
      padding: 30px;
      border-radius: 8px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
    }

    h2 {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 0;
      border-bottom: 2px solid #ddd;
      padding-bottom: 10px;
    }

    .timer {
      font-size: 1.2rem;
      color: #d9534f;
      font-weight: bold;
    }

    .question-block {
      margin-bottom: 30px;
      padding: 20px;
      background: #f1f1f1;
      border-radius: 5px;
      border-left: 5px solid #2196f3;
    }

    .question-block strong {
      display: block;
      margin-bottom: 10px;
      color: #333;
    }

    .question-block img {
      max-width: 100%;
      margin-top: 10px;
      border: 1px solid #ccc;
      border-radius: 5px;
    }

    .options {
      margin-top: 15px;
      padding-left: 15px;
    }

    .options label {
      display: flex;
      align-items: center;
      background: #fff;
      padding: 10px 15px;
      border: 1px solid #ccc;
      margin-bottom: 10px;
      border-radius: 5px;
      transition: 0.2s;
      cursor: pointer;
    }

    .options label:hover {
      background: #e8f4ff;
    }

    .options img {
      max-width: 150px;
      margin-left: 10px;
      border-radius: 3px;
    }

    button#submitBtn {
      display: block;
      margin: 30px auto 0;
      background: #28a745;
      color: white;
      border: none;
      padding: 12px 25px;
      border-radius: 5px;
      font-size: 1rem;
      cursor: pointer;
    }

    button#submitBtn:hover {
      background: #218838;
    }
  </style>
</head>
<body>
  <div class="container">
    <h2>
      <span id="exam-title">Attempt Exam</span>
      <span class="timer" id="timer">00:00</span>
    </h2>
    <form id="exam-form"></form>
    <button id="submitBtn" type="button">Submit</button>
  </div>

  <script>
    const examId = window.location.pathname.split('/').pop();
    let timerInterval;
    let timeRemaining = 0;
    let autoSubmitted = false;
    let studentId = null;

    // ðŸ›‘ Define beforeunload handler separately
    function beforeUnloadHandler(e) {
      e.preventDefault();
      e.returnValue = 'Your exam progress will be lost. Are you sure?';
    }

    window.addEventListener('beforeunload', beforeUnloadHandler);

    async function loadExam() {
      try {
        const res = await fetch(`/api/exam-questions/${examId}`);
        if (!res.ok) throw new Error('Failed to load exam questions');

        const data = await res.json();
        studentId = data.student_id;
        document.title = data.examTitle || 'Attempt Exam';
        document.getElementById('exam-title').textContent = data.examTitle || 'Attempt Exam';

        const startTime = new Date(data.start_time);
        const endTime = new Date(data.end_time);
        const now = new Date();

        timeRemaining = Math.floor((endTime - now) / 1000);
        if (timeRemaining <= 0) {
          alert('This exam has already ended.');
          window.removeEventListener('beforeunload', beforeUnloadHandler);
          window.location.href = '/student/dashboard';
          return;
        }

        startTimer(timeRemaining);

        const form = document.getElementById('exam-form');
        form.innerHTML = '';

        data.questions.forEach((q, i) => {
          const div = document.createElement('div');
          div.className = 'question-block';

          const questionHtml = q.question_text
            ? `<div>${q.question_text}</div>`
            : `<img src="${q.question_img}" alt="Question Image" />`;

          const qLabel = document.createElement('div');
          qLabel.innerHTML = `<strong>Q${i + 1} (${q.marks} Marks):</strong>${questionHtml}`;
          div.appendChild(qLabel);

          const optionsContainer = document.createElement('div');
          optionsContainer.className = 'options';

          q.options.forEach(opt => {
            const label = document.createElement('label');
            label.innerHTML = `
              <input type="radio" name="q_${q.question_id}" value="${opt.option_id}" />
              ${opt.option_text ? opt.option_text : `<img src="${opt.option_img}" alt="Option Image" />`}
            `;
            optionsContainer.appendChild(label);
          });

          div.appendChild(optionsContainer);
          form.appendChild(div);
        });

      } catch (err) {
        alert('Error loading exam. Please try again later.');
        console.error(err);
      }
    }

    function startTimer(duration) {
      const timer = document.getElementById('timer');
      timerInterval = setInterval(() => {
        if (duration <= 0) {
          clearInterval(timerInterval);
          if (!autoSubmitted) {
            alert("Time's up! Auto submitting your exam.");
            submitExam(true);
          }
          return;
        }

        const min = Math.floor(duration / 60).toString().padStart(2, '0');
        const sec = (duration % 60).toString().padStart(2, '0');
        timer.textContent = `${min}:${sec}`;
        timeRemaining = duration--;
      }, 1000);
    }

    async function submitExam(isAutoSubmitted = false) {
      if (autoSubmitted) return;
      autoSubmitted = true;

      clearInterval(timerInterval);

      const form = document.getElementById('exam-form');
      const formData = new FormData(form);
      const answers = [];

      for (const [key, val] of formData.entries()) {
        if (key.startsWith('q_')) {
          answers.push({
            question_id: key.split('_')[1],
            selected_option_id: val
          });
        }
      }

      if (!studentId) {
        alert('Student ID not found. Please login again.');
        window.removeEventListener('beforeunload', beforeUnloadHandler);
        window.location.href = '/login';
        return;
      }

      try {
        const res = await fetch('/api/save-answers', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            exam_id: examId,
            student_id: studentId,
            answers,
            is_auto_submitted: isAutoSubmitted
          })
        });

        if (res.ok) {
          alert('Exam submitted successfully!');
          window.removeEventListener('beforeunload', beforeUnloadHandler);
          window.location.href = `/exam/${examId}/testResult/${studentId}`;
        } else {
          const errorData = await res.json();
          alert('Failed to submit exam: ' + (errorData.error || 'Unknown error'));
          autoSubmitted = false;
        }
      } catch (err) {
        alert('Error submitting exam. Please try again.');
        console.error(err);
        autoSubmitted = false;
      }
    }

    document.getElementById('submitBtn').addEventListener('click', () => {
      if (confirm('Are you sure you want to submit the exam now?')) {
        submitExam(false);
      }
    });

    setInterval(() => {
      if (timeRemaining <= 0 && !autoSubmitted) {
        alert('Exam time has ended. Please submit or you will be logged out.');
        submitExam(true);
      }
    }, 10000);

    loadExam();
  </script>
</body>
</html>
